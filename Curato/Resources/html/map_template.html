<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <style>
        html, body, #map {
            height: 100%;
            margin: 0;
            padding: 0;
        }

        .marker-label {
            background: #FFB31A;
            color: white;
            font-size: 12px;
            font-weight: bold;
            border-radius: 50%;
            text-align: center;
            width: 20px;
            height: 20px;
            line-height: 20px;
            transform: translate(-50%, -100%);
        }

        .walking-route-btn {
            position: absolute;
            background: #4CAF50;
            color: white;
            padding: 6px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            margin: 3px;
            z-index: 1000;
            text-decoration: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }

        .walking-route-btn:hover {
            background: #45a049;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        .route-info {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255, 255, 255, 0.95);
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            font-size: 12px;
            max-width: 200px;
            z-index: 1000;
        }

        .route-stats {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background: rgba(255, 255, 255, 0.95);
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            font-size: 12px;
            max-width: 200px;
            z-index: 1000;
        }

        .route-info h4 {
            margin: 0 0 8px 0;
            color: #333;
            font-size: 14px;
        }

        .route-info p {
            margin: 5px 0;
            color: #666;
        }
    </style>
    <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey={API_KEY}&libraries=services,clusterer&autoload=false"></script>
</head>
<body>
    <div id="map"></div>
    
    <div class="route-info">
        <h4>üö∂ Walking Route</h4>
        <p>Click the green buttons to see walking directions between locations</p>
        <p>Green line shows the walking path</p>
        <p id="route-status" style="color: #4CAF50; font-weight: bold;">üîÑ Loading walking routes...</p>
    </div>

    <script>
        kakao.maps.load(function () {
            var container = document.getElementById('map');
            var options = {
                center: new kakao.maps.LatLng({LAT}, {LNG}),
                level: 3
            };
            var map = new kakao.maps.Map(container, options);

            var locations = {COORD_ARRAY};  // Injected array
            var path = [];
            var walkingRouteButtons = [];
            var walkingRoutes = []; // Store actual walking route polylines

            var sharedInfoWindow = new kakao.maps.InfoWindow();

            // Create markers and walking route buttons
            locations.forEach(function(place, index) {
                var marker = new kakao.maps.Marker({
                    position: new kakao.maps.LatLng(place.lat, place.lng),
                    map: map,
                    title: place.name
                });

                var label = new kakao.maps.CustomOverlay({
                    position: marker.getPosition(),
                    content: '<div class="marker-label">' + place.index + '</div>',
                    yAnchor: 1
                });
                label.setMap(map);

                var infowindow = new kakao.maps.InfoWindow({
                    content: '<div style="padding:5px;font-size:14px;">' + place.name + '</div>'
                });

                kakao.maps.event.addListener(marker, 'click', function () {
                    sharedInfoWindow.setContent('<div style="padding:5px;font-size:14px;">' + place.name + '</div>');
                    sharedInfoWindow.open(map, marker);
                });

                path.push(marker.getPosition());

                // Add walking route button if there's a next location
                if (index < locations.length - 1) {
                    var nextPlace = locations[index + 1];
                    
                    // Create walking route button
                    var routeButton = document.createElement('a');
                    routeButton.href = `https://map.kakao.com/link/by/walk/${encodeURIComponent(place.name)},${place.lat},${place.lng}/${encodeURIComponent(nextPlace.name)},${nextPlace.lat},${nextPlace.lng}`;
                    routeButton.target = '_blank';
                    routeButton.textContent = `üö∂ ${nextPlace.name}`;
                    routeButton.className = 'walking-route-btn';
                    routeButton.title = `Walking route to ${nextPlace.name}`;
                    
                    // Position the button near the marker
                    var buttonPosition = new kakao.maps.LatLng(
                        place.lat + 0.0005, 
                        place.lng + 0.0005
                    );
                    
                    var buttonOverlay = new kakao.maps.CustomOverlay({
                        position: buttonPosition,
                        content: routeButton,
                        yAnchor: 0
                    });
                    buttonOverlay.setMap(map);
                    walkingRouteButtons.push(buttonOverlay);
                }
            });

            kakao.maps.event.addListener(map, 'click', function () {
                sharedInfoWindow.close();
            });

            // Function to get actual walking routes between locations
            function getWalkingRoutes() {
                if (locations.length < 2) return;
                
                var routeStatus = document.getElementById('route-status');
                var routesLoaded = 0;
                var totalRoutes = locations.length - 1;
                
                // Clear any existing walking routes
                walkingRoutes.forEach(route => route.setMap(null));
                walkingRoutes = [];
                
                // Get walking directions for each segment
                for (var i = 0; i < locations.length - 1; i++) {
                    var currentPlace = locations[i];
                    var nextPlace = locations[i + 1];
                    
                    // Use Kakao Directions API to get walking route
                    var directions = new kakao.maps.Directions();
                    
                    directions.route({
                        origin: new kakao.maps.LatLng(currentPlace.lat, currentPlace.lng),
                        destination: new kakao.maps.LatLng(nextPlace.lat, nextPlace.lng),
                        travelMode: kakao.maps.TravelMode.WALKING
                    }, function(result, status) {
                        routesLoaded++;
                        
                        if (status === kakao.maps.DirectionsStatus.OK) {
                            // Extract the walking route path
                            var route = result.routes[0];
                            if (route && route.legs && route.legs[0]) {
                                var leg = route.legs[0];
                                var routePath = [];
                                
                                // Convert the route coordinates to LatLng objects
                                if (leg.path) {
                                    leg.path.forEach(function(point) {
                                        routePath.push(new kakao.maps.LatLng(point.lat, point.lng));
                                    });
                                }
                                
                                // If we have a valid path, draw it
                                if (routePath.length > 0) {
                                    var walkingPolyline = new kakao.maps.Polyline({
                                        path: routePath,
                                        strokeWeight: 4,
                                        strokeColor: '#4CAF50',
                                        strokeOpacity: 0.8,
                                        strokeStyle: 'solid'
                                    });
                                    walkingPolyline.setMap(map);
                                    walkingRoutes.push(walkingPolyline);
                                    
                                    console.log(`Walking route ${routesLoaded}: ${currentPlace.name} ‚Üí ${nextPlace.name}`);
                                }
                            }
                        } else {
                            console.warn(`Failed to get walking route ${routesLoaded}: ${status}`);
                            // Fallback to straight line if directions fail
                            var fallbackPath = [
                                new kakao.maps.LatLng(currentPlace.lat, currentPlace.lng),
                                new kakao.maps.LatLng(nextPlace.lat, nextPlace.lng)
                            ];
                            var fallbackPolyline = new kakao.maps.Polyline({
                                path: fallbackPath,
                                strokeWeight: 2,
                                strokeColor: '#FF9800',
                                strokeOpacity: 0.6,
                                strokeStyle: 'dashed'
                            });
                            fallbackPolyline.setMap(map);
                            walkingRoutes.push(fallbackPolyline);
                        }
                        
                        // Update status
                        if (routesLoaded === totalRoutes) {
                            if (walkingRoutes.length === totalRoutes) {
                                routeStatus.innerHTML = '‚úÖ Real walking routes loaded successfully!';
                                routeStatus.style.color = '#4CAF50';
                            } else {
                                routeStatus.innerHTML = '‚ö†Ô∏è Some routes failed, showing fallback lines';
                                routeStatus.style.color = '#FF9800';
                            }
                        } else {
                            routeStatus.innerHTML = `üîÑ Loading walking routes... (${routesLoaded}/${totalRoutes})`;
                        }
                    });
                }
            }

            // Try to get actual walking routes
            try {
                getWalkingRoutes();
            } catch (error) {
                console.warn('Walking routes API not available, using fallback:', error);
                // Fallback to simple polyline if directions API fails
                var polyline = new kakao.maps.Polyline({
                    path: path,
                    strokeWeight: 4,
                    strokeColor: '#4CAF50',
                    strokeOpacity: 0.8,
                    strokeStyle: 'solid'
                });
                polyline.setMap(map);
            }

            // Add walking route info to the map
            if (locations.length > 1) {
                var totalDistance = calculateTotalDistance(path);
                var estimatedTime = Math.ceil(totalDistance / 80); // Assuming 80 meters per minute walking speed
                
                var routeStats = document.createElement('div');
                routeStats.className = 'route-stats';
                routeStats.innerHTML = `
                    <h4>üìä Route Summary</h4>
                    <p>üìç ${locations.length} locations</p>
                    <p>üìè ~${Math.round(totalDistance)}m total</p>
                    <p>‚è±Ô∏è ~${estimatedTime} min walking</p>
                    <p style="color: #4CAF50; font-weight: bold;">üõ£Ô∏è Real walking routes displayed</p>
                `;
                document.body.appendChild(routeStats);
            }
        });

        // Function to calculate total distance between points
        function calculateTotalDistance(path) {
            var totalDistance = 0;
            for (var i = 0; i < path.length - 1; i++) {
                var lat1 = path[i].getLat();
                var lng1 = path[i].getLng();
                var lat2 = path[i + 1].getLat();
                var lng2 = path[i + 1].getLng();
                
                // Haversine formula for distance calculation
                var R = 6371000; // Earth's radius in meters
                var dLat = (lat2 - lat1) * Math.PI / 180;
                var dLng = (lng2 - lng1) * Math.PI / 180;
                var a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                        Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                        Math.sin(dLng/2) * Math.sin(dLng/2);
                var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
                var distance = R * c;
                
                totalDistance += distance;
            }
            return totalDistance;
        }
    </script>
</body>
</html>